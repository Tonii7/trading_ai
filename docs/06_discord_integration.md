# Eldar — TradingAI Technical Intelligence Book  
## Section 6 — Discord Integration Layer  
(Интеграция TradingAI с Discord)

---

## Введение

Discord — это внешний интерфейс системы TradingAI.  
Через него:

- пользователь отдаёт команды  
- получает отчёты и аналитику  
- запускает агентов  
- диагностирует работу системы  
- управляет потоками информации  

Discord является **UI-слоем** TradingAI.  
Все взаимодействие с системой проходит через него.

---

# 6.1. Назначение Discord-модуля

Discord-модуль отвечает за:

- приём команд пользователя  
- маршрутизацию команд → Supervisor Agent  
- получение результатов от CrewAI  
- визуализацию результатов  
- отправку embed-сообщений, таблиц, файлов  
- журналирование действий  
- отладку каналов и прав  

Discord выступает как «панель управления TradingAI».

---

# 6.2. Архитектура Discord-модуля

Структура:

```
src/trading_ai/services/discord/
├── discord_client.py
├── handlers.py
├── crew_dispatcher.py
├── router.py
├── utils.py
└── (прочие вспомогательные файлы)
```

Каждый файл выполняет отдельную функцию.

---

## 6.3. Основные компоненты

### 1) **discord_client.py**
Отвечает за:

- подключение к Discord API  
- авторизацию по токену  
- подписку на события (on_message, on_ready)  
- запуск event-loop  

Это основной клиент.

---

### 2) **handlers.py**
Содержит обработчики:

- команд  
- пользовательских запросов  
- реакций  
- тестовых сообщений  

Здесь система «понимает», что от неё хочет пользователь.

---

### 3) **crew_dispatcher.py**
Связующее звено между Discord и CrewAI.

Функции:

- принимает запрос от handlers.py  
- формирует задание для Supervisor  
- передаёт данные агентам  
- собирает результаты  
- возвращает готовый ответ в Discord  

Crew Dispatcher — центральный мост двух систем.

---

### 4) **router.py**
Определяет маршруты команд.

Например:

```
/market → Market Analyzer  
/session → NY Session Engine  
/crew → Supervisor  
/test → Debug  
```

Router помогает поддерживать чистую архитектуру.

---

### 5) **utils.py**
Вспомогательные методы:

- форматирование текста  
- создание embed-сообщений  
- отправка файлов  
- логирование  

---

# 6.4. Поток выполнения команды (Command → Response)

```
Пользователь → Discord Bot → Handler → Crew Dispatcher → Supervisor → Agents
  → Supervisor → Dispatcher → Discord → Пользователь
```

Детализированный flow:

1. Пользователь пишет:  
   ```
   /analyze US30
   ```

2. Discord Client получает сообщение  
3. Handler определяет команду  
4. Router определяет код, который нужно выполнить  
5. Crew Dispatcher создаёт задачу  
6. Supervisor запускает агентов  
7. Агенты запрашивают данные у сервисов (cTrader, Market Engine)  
8. Вся информация собирается  
9. Discord отправляет итоговый отчёт обратно пользователю  

---

# 6.5. Управление разрешениями (Permissions Layer)

TradingAI использует:

- проверки пользовательских ID  
- безопасные каналы  
- приватные каналы для логов  
- приватные ключи API  

Существует 2 метода проверки:

### **1) debug_channels.py**  
Показывает список каналов и доступов.

### **2) debug_bot_permissions.py**  
Проверяет, какие права есть у бота.

Эти скрипты необходимы при:

- переходе на новый сервер  
- подгрузке новых модулей  
- тестировании авторизации  

---

# 6.6. Output Routes (маршрутизация)

Конфигурационный файл:

```
src/trading_ai/config/output_routes.yaml
```

Определяет:

- куда отправлять отчёты  
- какой канал получает какие данные  
- какие модули включены  
- какие модули выключены  

Пример:

```
discord:
  market_reports: CHANNEL_ID_1
  crew_logs: CHANNEL_ID_2
  errors: CHANNEL_ID_3

files:
  enable: true
```

Это делает систему гибкой.

---

# 6.7. Поддержка файлов и вложений

Discord-модуль умеет отправлять:

- json-файлы  
- отчёты  
- картинки  
- вложения  
- таблицы  

Используется для:

- NY Session логов  
- CrewAI отчётов  
- Market Snapshot  
- Debug данных  

---

# 6.8. Отладочные команды

Примеры:

```
/ping
/server
/check_channels
/check_permissions
/test_market
/test_crew
```

Это позволяет диагностировать весь pipeline.

---

# 6.9. Потенциальные ошибки и решения

| Проблема | Причина | Решение |
|---------|---------|---------|
| Бот не запускается | неверный токен | проверить .env |
| Команды не работают | отсутствуют permissions | запустить debug_permissions |
| Не отправляет файлы | ограничения Discord API | уменьшить размер |
| Не подключается | firewall / proxy | открыть порты |

---

# 6.10. Итоги секции

Discord-интеграция — это ключевой пользовательский интерфейс TradingAI, который:

- управляет системой  
- взаимодействует с CrewAI  
- позволяет работать с отчётами  
- обеспечивает удобный UX  
- является основой операционной среды  

Через Discord реализована **управляемая, прозрачная, безопасная связь** между человеком и многоагентной AI-системой.
