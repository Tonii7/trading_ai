# Eldar — TradingAI Technical Intelligence Book  
## Section 7 — cTrader Integration Layer  
(Интеграция TradingAI с платформой cTrader Open API)

---

## Введение

Система TradingAI использует **cTrader Open API** для получения рыночной информации:

- цены  
- свечи  
- bid/ask  
- спреды  
- параметры инструментов  
- метаданные символов  
- текущие торговые условия  

Этот модуль является **основой рыночного слоя (Market Layer)** всей системы.

Все агенты, принимающие решения (Market Analyzer, Session Engine, Supervisor), используют данные, предоставляемые cTrader Integration Layer.

---

# 7.1. Структура модуля cTrader

```
src/trading_ai/services/ctrader/
├── ctrader_openapi_client.py
├── ctrader_price_source.py
├── ctrader_candles_data.py
├── ctrader_symbol_details.py
├── ctrader_symbols_data.py
└── market_snapshot.py
```

Каждый файл отвечает за строго определённую функциональность:

---

# 7.2. ctrader_openapi_client.py  
(Главный клиент работы с API)

### Назначение:
- управление подключением к API  
- авторизация  
- HTTP-вызовы  
- обработка ответов  
- обработка ошибок API  

### Ключевые функции:

1. Авторизация через Client ID / Secret  
2. Получение токена  
3. Выполнение запросов `GET / POST`  
4. Обработка статусов 200 / 400 / 404 / 500  
5. Ретраи в случае отказов  

### Типичный вызов:

```
client.get("/symbols")
client.get(f"/candles/{symbol}/{tf}")
client.get(f"/price/{symbol}")
```

Этот модуль — фундамент всего взаимодействия с рынком.

---

# 7.3. ctrader_price_source.py  
(Источник цен в реальном времени)

### Назначение:
Получение:

- bid  
- ask  
- last  
- spread  
- текущее время биржи  
- состояние рынка  

### Сценарии использования:

- получение цены инструмента  
- определение направления свечи  
- оценка движения в моменте  
- поддержка Session Engine  
- проверка рыночных условий  

Этот модуль используется постоянно.

---

# 7.4. ctrader_candles_data.py  
(Модуль исторических и актуальных свечей)

### Назначение:

Получение свечей:

- M1  
- M5  
- M15  
- M30  
- 1H  
- 4H  
- 1D  

### Данные:

- open  
- high  
- low  
- close  
- volume  
- время открытия/закрытия  
- статус свечи  

### Возможности:

- запрос нескольких свечей  
- обработка пропущенных баров  
- агрегирование данных  
- передача в агенты для анализа  

Market Analyzer и Session Engine используют этот модуль для построения картины рынка.

---

# 7.5. ctrader_symbol_details.py  
(Метаданные инструментов)

### Назначение:

Получение информации об инструменте:

- минимальный шаг  
- спред  
- гарантийное обеспечение  
- тип символа  
- точность котировок  
- лотность  
- торговые ограничения  

### Используется:

- при анализе условий торговли  
- при риск-менеджменте  
- при построении snapshot  

---

# 7.6. ctrader_symbols_data.py  
(Список всех инструментов)

### Назначение:
Получение полного набора символов, доступных у брокера.

### Используется:

- для валидации символов  
- проверки доступности US30 / XAUUSD / DE40 и др.  
- интеграции с Market Engine  

---

# 7.7. market_snapshot.py  
(Единый snapshot рынка)

### Назначение:

Построение одного объединённого пакета данных:

- текущие цены  
- спред  
- условия инструмента  
- статус рынка  
- время  
- результаты анализа  

Это фактически **центральная точка данных**, используемая агентами CrewAI.

---

# 7.8. Поток данных cTrader → TradingAI

```
cTrader API
     ↓
ctrader_openapi_client.py
     ↓
ctrader_price_source.py / candles_data.py / symbols_data.py
     ↓
market_snapshot.py
     ↓
CrewAI Agents
     ↓
Discord Output / Logs
```

---

# 7.9. Типичные запросы агентов

### Market Analyzer:
```
snapshot = market_snapshot.get("US30")
candles = get_candles("US30", "M15")
```

### Session Engine:
```
session_data = get_candles("XAUUSD", "M5")
```

### Supervisor:
```
check_market_status(symbol)
```

---

# 7.10. Обработка ошибок

Основные виды ошибок:

| Ошибка | Причина | Решение |
|--------|---------|---------|
| 404 Not Found | Символ недоступен | Проверить символ |
| 429 Too Many Requests | Лимит API | Ретраи + задержка |
| 500 Server Error | Сторона брокера | Повтор запроса |
| Timeout | Нет ответа | Увеличить таймаут |

Модуль должен быть устойчивым — это критично для анализа рынка.

---

# 7.11. Лучшие практики реализации

- не запрашивать лишние данные  
- использовать session caching  
- применять retry/backoff  
- логировать все ошибки  
- писать snapshot как JSON  

---

# 7.12. Итоги секции

Модуль cTrader является фундаментом TradingAI, обеспечивая:

- прозрачный доступ к рыночным данным  
- надёжный канал обмена  
- устойчивость и проверку ошибок  
- совместимость с многоагентной архитектурой  

Без cTrader Integration Layer система не может выполнять анализ и построение рыночного контекста.
